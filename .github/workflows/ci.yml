name: CI â†’ Remote Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  remote-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger remote tests & wait
        env:
          TEST_API_TOKEN: ${{ secrets.TRYNARRATIVE_API_TOKEN }}
          SERVICE_URL: https://10df-205-254-163-40.ngrok-free.app
        run: |
          # 1) Read and base64-encode your YAML
          cfg=$(base64 -w0 < trynarrative.yml)

          # 2) Kick off a test run
          resp=$(curl -s -X POST $SERVICE_URL/run-tests \
            -H "Authorization: Bearer $TRYNARRATIVE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                 "repo": "'"${{ github.repository }}"'",
                 "commit": "'"${{ github.sha }}"'",
                 "config": "'"$cfg"'"
               }')
          run_id=$(echo "$resp" | jq -r .run_id)
          echo "ðŸ‘‰ Test run ID is $run_id"

          # 3) Poll status up to 5 minutes
          for i in {1..30}; do
            status=$(curl -s $SERVICE_URL/results/$run_id | jq -r .status)
            echo "Status: $status"
            if [ "$status" = "done" ]; then
              result=$(curl -s $SERVICE_URL/results/$run_id/summary | jq -r .result)
              echo "Result: $result"
              [ "$result" = "ok" ] || exit 1
              exit 0
            fi
            sleep 10
          done

          echo "âŒ Timed out waiting for test results"
          exit 1
